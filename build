#!/usr/bin/env bash
set -euo pipefail

OUT_DIR=${OUT_DIR:-bin}
VERSION=${VERSION:-$(git describe --tags --dirty --always 2>/dev/null || echo dev)}
MAN_DIR=${MAN_DIR:-share/man/man1}
mkdir -p "$OUT_DIR"
echo "Building show $VERSION -> $OUT_DIR/show"
LDFLAGS="-s -w -X main.version=$VERSION"
env CGO_ENABLED=${CGO_ENABLED:-0} GOOS=${GOOS:-} GOARCH=${GOARCH:-} \
  go build -trimpath -ldflags="$LDFLAGS" -o "$OUT_DIR/show" ./cmd/show
if [ -f man/show.1 ]; then
  mkdir -p "$OUT_DIR/$MAN_DIR"
  cp man/show.1 "$OUT_DIR/$MAN_DIR/show.1"
  if command -v gzip >/dev/null 2>&1; then
    gzip -n -c man/show.1 > "$OUT_DIR/$MAN_DIR/show.1.gz"
  fi
  echo "Man page: $OUT_DIR/$MAN_DIR/show.1"
fi
echo "Done. Usage: <cmd> | $OUT_DIR/show -p 8000"
